apiVersion: networking.istio.io/v1
kind: DestinationRule
metadata:
  name: product-service
spec:
  host: product-service
  subsets:
    - name: v1
      labels:
        version: v1
    - name: v2
      labels:
        version: v2
    - name: v3
      labels:
        version: v3
    - name: v4
      labels:
        version: v4
    - name: latest
      labels:
        version: latest
  trafficPolicy: # <- add trafficPolicy here
    connectionPool:
      tcp:
        maxConnections: 100        # max concurrent TCP connections
      http:
        http1MaxPendingRequests: 50  # pending HTTP requests per connection
        maxRequestsPerConnection: 20
    outlierDetection: # <- circuit breaker / unhealthy instance detection
      consecutive5xxErrors: 5       # consider instance unhealthy after 5 consecutive 5xx errors
      interval: 10s                 # check every 10 seconds
      baseEjectionTime: 30s         # eject unhealthy instance for 30 seconds
      maxEjectionPercent: 50